<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Unmei - 出会いが鳴り、恋が奏でる運命</title>

<!-- Playfair Display（統一フォント） -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root { --gold:#ffd700; }

  /* === 全体レイアウト：左にゲーム、右に認証パネル === */
  body{
    margin:0;
    background:#000;
    height:100svh;
    overflow:hidden;
    font-family:'Playfair Display', serif;
    color:var(--gold);
  }
  .app{
    display:flex;
    height:100svh;
    width:100vw;
  }

  /* 左：ステージ（縮尺フィット） */
  .stage-wrap{
    position:relative;
    flex:1 1 auto;           /* 余白は全部こちらへ */
    width:100%;
    height:100%;
    overflow:hidden;
  }
  .stage{
    position:absolute;
    left:50%;
    top:50%;
    width:1280px;              /* 基準幅 */
    height:720px;              /* 基準高 */
    transform-origin:center center; /* scaleはJSで設定します */
    background:radial-gradient(circle at center,#1c0d0d 0%,#000 80%);
    border-radius:10px;
    box-shadow:0 0 40px rgba(255,215,0,0.08) inset;
  }

  /* ===== ステージ内UI ===== */
  h1{
    position:absolute; left:50%; top:40px; transform:translateX(-50%);
    margin:0; font-size:72px; letter-spacing:3px;
    text-shadow:0 0 25px rgba(255,215,0,1);
  }
  .subtitle{
    position:absolute; left:50%; top:120px; transform:translateX(-50%);
    margin:0; font-size:22px; letter-spacing:2px;
    text-shadow:0 0 15px rgba(255,215,0,0.8); text-align:center;
  }

  .slot{
    position:absolute; left:50%; top:160px; transform:translateX(-50%);
    display:flex; gap:16px;
  }
  .slot-box{
    width:120px; height:100px;
    background:linear-gradient(180deg,#2a1b1b,#3a0303);
    border:2px solid var(--gold); border-radius:12px;
    display:flex; align-items:center; justify-content:center;
    text-align:center; font-weight:700; font-size:20px;
    box-shadow:0 0 15px rgba(255,215,0,0.45);
    user-select:none; transition:filter .2s, box-shadow .2s;
  }
  .spinning{ filter:saturate(1.2) brightness(1.1); box-shadow:0 0 18px rgba(255,215,0,0.6); }
  .stopped { filter:none; }

  .cta{
    position:absolute; left:50%; top:340px; transform:translateX(-50%);
    background:linear-gradient(90deg,#8b0000,#b30000);
    color:var(--gold); border:2px solid var(--gold); border-radius:12px;
    padding:14px 36px; font-size:24px; cursor:pointer;
    text-shadow:0 0 12px rgba(255,215,0,0.8);
    box-shadow:0 0 25px rgba(255,215,0,0.35);
    transition:transform .25s, box-shadow .25s, filter .25s; z-index:5;
  }
  .cta:hover{ transform:translateX(-50%) translateY(-1px) scale(1.04); box-shadow:0 0 35px rgba(255,215,0,0.8); filter:brightness(1.05); }
  .cta:active{ transform:translateX(-50%) translateY(0) scale(0.98); box-shadow:0 0 22px rgba(255,215,0,0.6); }

  .keys{
    position:absolute; left:50%; bottom:0; transform:translateX(-50%);
    display:flex; gap:2px; padding:8px 0 10px; pointer-events:none;
  }
  .key{ width:64px; height:280px; background:linear-gradient(to bottom,#fff,#ddd);
        border:1px solid #444; border-radius:4px; position:relative;
        box-shadow:0 4px 10px rgba(255,255,255,0.08);}
  .key.black{ width:42px; height:180px; background:linear-gradient(to bottom,#111,#000);
              margin:0 -21px; z-index:2; border-color:#222; box-shadow:0 4px 10px rgba(0,0,0,0.35);}
  .flash{ box-shadow:0 0 22px rgba(255,215,0,0.9)!important; filter:brightness(2) saturate(1.2); }

  .footer-note{ position:absolute; left:50%; bottom:8px; transform:translateX(-50%); font-size:14px; opacity:.85; }

  .result-line, .result-summary{
    position:absolute; left:50%; transform:translateX(-50%);
    text-shadow:0 0 18px rgba(255,215,0,0.9); opacity:0; transition:opacity .9s ease;
    text-align:center; white-space:pre-wrap; letter-spacing:2px;
  }
  .result-line{ top:460px; font-size:28px; }
  .result-summary{ top:520px; font-size:22px; }
  .show{ opacity:1; }

  .page-bg { position:fixed; inset:0; background:#000; z-index:-1; }

  /* 右：ログイン/登録パネル */
  .side{
    width:min(420px, 42vw);
    border-left:1px solid rgba(255,215,0,.15);
    background:linear-gradient(180deg,#0a0606,#000);
    padding:18px 16px 14px;
    display:flex; flex-direction:column; gap:12px;
  }
  .side h2{ margin:0 0 6px; font-size:22px; letter-spacing:1px; text-shadow:0 0 12px rgba(255,215,0,.6); }
  .tabs{ display:flex; gap:8px; }
  .tab{
    flex:1; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,215,0,.35);
    background:#1a1212; color:var(--gold); cursor:pointer; font-size:14px;
  }
  .tab.active{ background:#3a1a1a; border-color:var(--gold); }
  .pane.hidden{ display:none; }

  .field{ display:flex; flex-direction:column; gap:6px; margin-top:8px; }
  .field label{ font-size:13px; opacity:.95; }
  .field input, .field select{
    width:100%; padding:10px; border-radius:10px; border:1px solid #443;
    background:#0e0a0a; color:#fff; font-size:15px;
  }

  .side-btn{
    padding:10px 12px; border-radius:10px; border:1px solid var(--gold);
    background:#240909; color:var(--gold); cursor:pointer; font-size:15px;
  }
  .side-btn.ghost{ border-color:#666; color:#ddd; background:#111; }
  .side-btn.warning{ border-color:#b66; color:#fdd; background:#2a0a0a; }
  .note{ font-size:12px; opacity:.8; margin:4px 0 0; }
  .current{
    margin-top:6px; padding:10px; border:1px dashed rgba(255,215,0,.35); border-radius:10px; font-size:14px;
  }

  /* モバイル時はサイドを下配置 */
  @media (max-width: 980px){
    .app{ flex-direction:column; }
    .side{ width:100%; height:auto; order:-1; border-left:none; border-bottom:1px solid rgba(255,215,0,.15); }
  }
</style>
</head>
<body>
  <div class="page-bg"></div>

  <div class="app">
    <!-- 左：ゲーム -->
    <div class="stage-wrap">
      <div class="stage" id="stage">
        <h1>Unmei</h1>
        <p class="subtitle">出会いが鳴り、恋が奏でる運命</p>

        <div class="slot" aria-live="polite">
          <div class="slot-box" data-field="height">身長</div>
          <div class="slot-box" data-field="face">顔</div>
          <div class="slot-box" data-field="mbti">MBTI</div>
          <div class="slot-box" data-field="age">年齢</div>
          <div class="slot-box" data-field="country">国籍</div>
        </div>

        <button class="cta" aria-label="運命を奏でる（スタート）">運命を奏でる</button>

        <!--  同階層に置いたMP3 -->
        <audio id="bgm" preload="auto">
          <source src="beethoven_symphony5_1.mp3" type="audio/mpeg" />
        </audio>

        <!-- 鍵盤 -->
        <div class="keys" aria-hidden="true">
          <div class="key"></div><div class="key black"></div><div class="key"></div><div class="key black"></div>
          <div class="key"></div><div class="key"></div><div class="key black"></div><div class="key"></div>
          <div class="key black"></div><div class="key"></div><div class="key black"></div><div class="key"></div>
          <div class="key"></div><div class="key black"></div><div class="key"></div><div class="key black"></div>
          <div class="key"></div><div class="key"></div><div class="key black"></div><div class="key"></div>
          <div class="key black"></div><div class="key"></div><div class="key black"></div><div class="key"></div>
          <div class="key"></div><div class="key black"></div><div class="key"></div><div class="key black"></div><div class="key"></div>
        </div>

        <div class="footer-note">© 2025 Unmei Project</div>

        <!-- 結果テキスト -->
        <div class="result-line" id="resultLine">あなたの運命の相手は...</div>
        <div class="result-summary" id="resultSummary"></div>
      </div>
    </div>

    <!-- 右：ログイン/登録 -->
    <aside class="side">
      <h2>Unmei アカウント</h2>
      <div class="tabs">
        <button class="tab active" data-tab="login">ログイン</button>
        <button class="tab" data-tab="register">新規登録</button>
      </div>

      <!-- ログイン -->
      <div id="pane-login" class="pane">
        <div class="field">
          <label>ユーザー選択</label>
          <select id="loginUser"></select>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px;">
          <button id="doLogin" class="side-btn">ログイン</button>
          <button id="deleteUser" class="side-btn ghost">選択ユーザー削除</button>
        </div>
        <div class="current" id="currentUserView">未ログイン</div>
      </div>

      <!-- 新規登録 -->
      <div id="pane-register" class="pane hidden">
        <div class="field">
          <label>表示名（偽名OK）</label>
          <input id="regName" type="text" placeholder="例：アリ / take" />
        </div>
        <div class="field">
          <label>年齢</label>
          <input id="regAge" type="number" min="10" max="120" placeholder="例：21" />
        </div>
        <div class="field">
          <label>顔の系統</label>
          <select id="regFace"></select>
        </div>
        <div class="field">
          <label>MBTI</label>
          <select id="regMBTI"></select>
        </div>
        <div class="field">
          <label>国籍</label>
          <select id="regCountry"></select>
        </div>
        <button id="doRegister" class="side-btn" style="margin-top:10px;">登録する</button>
        <p class="note">※表示名は偽名でOK。保存はこの端末（localStorage）のみ。</p>
      </div>

      <hr style="width:100%; border:0; border-top:1px solid rgba(255,215,0,.15); margin:8px 0;">
      <button id="logout" class="side-btn warning">ログアウト</button>
    </aside>
  </div>

<script>
(function(){
  /* ===== ステージを常に画面内に収めるスケーリング ===== */
  const stage = document.getElementById('stage');
  const BASE_W = 1280, BASE_H = 720;
  function fitStage(){
    // 右のサイドバーを含めたウィンドウサイズに対して縮尺計算
    const sw = stage.parentElement.clientWidth;  // 左カラムの幅だけを使う
    const sh = stage.parentElement.clientHeight; // 左カラムの高さ
    const scale = Math.min(sw / BASE_W, sh / BASE_H);
    stage.style.transform = `translate(-50%, -50%) scale(${scale})`;
  }
  window.addEventListener('resize', fitStage);
  window.addEventListener('orientationchange', fitStage);
  fitStage();

  /* ===== データ ===== */
  const faces = ["しお顔","ソース顔","とんこつ顔","砂糖顔","しょうゆ顔","塩バター顔"];
  const mbti  = ["INTJ","INFP","ENTP","ENFJ","ISTP","ISFP","ESTJ","ESFP","ISTJ","INFJ","ENTJ","ENFP","ISFJ","ESFJ","ESTP","INTP"];
  const countries = ["日本","韓国","フランス","イギリス","ドイツ","イタリア","アメリカ","ブラジル","エジプト","タイ","スペイン","カナダ","オーストラリア"];

  /* ===== ゲーム要素 ===== */
  const boxes = Array.from(document.querySelectorAll(".slot-box"));
  const keys  = Array.from(document.querySelectorAll(".keys .key"));
  const btn   = document.querySelector(".cta");
  const bgm   = document.getElementById("bgm");
  const line = document.getElementById("resultLine");
  const summary = document.getElementById("resultSummary");

  const cues = {
    line:     1500,   // あなたの運命の相手は...
    height:   4200,   // 身長
    face:     7500,   // 顔
    mbti:     9800,   // MBTI
    age:     12100,   // 年齢
    country:  14500,  // 国籍
    summary:  17500   // まとめ
  };

  const timeouts = [];
  const spinners = [];
  function schedule(fn, delayMs, startMs){
    const h = setTimeout(fn, Math.max(0, startMs + delayMs - performance.now()));
    timeouts.push(h);
  }
  function clearAll(){
    while(timeouts.length){ clearTimeout(timeouts.pop()); }
    spinners.splice(0).forEach(id => clearInterval(id));
  }
  function flashKey(){
    const k = keys[Math.floor(Math.random()*keys.length)];
    if(!k) return; k.classList.add("flash"); setTimeout(()=>k.classList.remove("flash"), 120);
  }
  function startSpin(){
    boxes.forEach((box)=>{
      box.classList.add("spinning");
      const id=setInterval(()=>{
        switch(box.dataset.field){
          case "height":  box.textContent=(150+Math.floor(Math.random()*51))+"cm"; break;
          case "face":    box.textContent=faces[Math.floor(Math.random()*faces.length)]; break;
          case "mbti":    box.textContent=mbti[Math.floor(Math.random()*mbti.length)]; break;
          case "age":     box.textContent=(18+Math.floor(Math.random()*23))+"歳"; break;
          case "country": box.textContent=countries[Math.floor(Math.random()*countries.length)]; break;
        }
      }, 45);
      spinners.push(id);
    });
  }
  function stopBox(i){
    if (spinners[i]) { clearInterval(spinners[i]); spinners[i]=null; }
    boxes[i].classList.remove("spinning");
    boxes[i].classList.add("stopped");
    flashKey();
    return boxes[i].textContent;
  }

  /* ===== ユーザー管理（localStorage） ===== */
  const USERS_KEY = "unmeiUsers";
  const CURRENT_ID_KEY = "unmeiCurrentUserId";

  const $ = (sel)=>document.querySelector(sel);

  // ログイン/登録 UI
  const tabs = Array.from(document.querySelectorAll(".tab"));
  const paneLogin = $("#pane-login");
  const paneRegister = $("#pane-register");
  const loginSelect = $("#loginUser");
  const doLoginBtn = $("#doLogin");
  const delUserBtn = $("#deleteUser");
  const logoutBtn = $("#logout");
  const curView = $("#currentUserView");

  const regName = $("#regName");
  const regAge = $("#regAge");
  const regFace = $("#regFace");
  const regMBTI = $("#regMBTI");
  const regCountry = $("#regCountry");
  const doRegisterBtn = $("#doRegister");

  // セレクトに選択肢投入
  function fillOptions(select, arr){
    select.innerHTML = '<option value="">（未設定）</option>' + arr.map(v=>`<option value="${v}">${v}</option>`).join('');
  }
  fillOptions(regFace, faces);
  fillOptions(regMBTI, mbti);
  fillOptions(regCountry, countries);

  // ストレージ I/O
  function loadUsers(){
    try{ return JSON.parse(localStorage.getItem(USERS_KEY) || "[]"); }catch(_){ return []; }
  }
  function saveUsers(arr){
    localStorage.setItem(USERS_KEY, JSON.stringify(arr));
  }
  function setCurrentId(id){
    if(id==null){ localStorage.removeItem(CURRENT_ID_KEY); }
    else{ localStorage.setItem(CURRENT_ID_KEY, String(id)); }
  }
  function getCurrentId(){
    return localStorage.getItem(CURRENT_ID_KEY);
  }
  function getCurrentUser(){
    const id = getCurrentId();
    if(!id) return null;
    return loadUsers().find(u=>String(u.id)===String(id)) || null;
  }
  function refreshLoginSelect(){
    const users = loadUsers();
    loginSelect.innerHTML = users.length
      ? users.map(u=>`<option value="${u.id}">${u.displayName} (${u.country||'国籍不明'})</option>`).join('')
      : '<option value="">（ユーザー未登録）</option>';
  }
  function refreshCurrentView(){
    const me = getCurrentUser();
    if(me){
      curView.textContent = `ログイン中：${me.displayName} / ${me.age?me.age+'歳':'年齢:不明'} / ${me.face||'顔の系統:不明'} / ${me.mbti||'MBTI:不明'} / ${me.country||'国籍:不明'}`;
    }else{
      curView.textContent = '未ログイン';
    }
  }

  // 初期化
  refreshLoginSelect();
  refreshCurrentView();

  // タブ切り替え
  tabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      tabs.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      paneLogin.classList.toggle('hidden', tab!=='login');
      paneRegister.classList.toggle('hidden', tab!=='register');
    });
  });

  // 新規登録
  doRegisterBtn.addEventListener('click', ()=>{
    const name = (regName.value || '').trim();
    if(!name){ alert('表示名（偽名OK）を入力してください'); return; }
    const age = regAge.value ? Math.max(0, Math.min(150, Number(regAge.value)|0)) : "";
    const user = {
      id: Date.now().toString(36) + Math.random().toString(36).slice(2,7),
      displayName: name,
      age: age ? String(age) : "",
      face: regFace.value || "",
      mbti: regMBTI.value || "",
      country: regCountry.value || ""
    };
    const list = loadUsers(); list.push(user); saveUsers(list);
    setCurrentId(user.id);
    refreshLoginSelect(); refreshCurrentView();
    // フィールド軽くクリア
    regName.value = ""; regAge.value=""; regFace.value=""; regMBTI.value=""; regCountry.value="";
    alert('登録しました！ログイン状態になりました。');
    // ログインタブへ
    document.querySelector('.tab[data-tab="login"]').click();
  });

  // ログイン
  doLoginBtn.addEventListener('click', ()=>{
    const id = loginSelect.value;
    if(!id){ alert('ユーザーを選択してください'); return; }
    setCurrentId(id);
    refreshCurrentView();
    alert('ログインしました');
  });

  // ユーザー削除（選択中）
  delUserBtn.addEventListener('click', ()=>{
    const id = loginSelect.value;
    if(!id){ alert('削除するユーザーを選択してください'); return; }
    const list = loadUsers();
    const idx = list.findIndex(u=>String(u.id)===String(id));
    if(idx>=0){
      if(!confirm(`本当に削除しますか？\n${list[idx].displayName}`)) return;
      list.splice(idx,1); saveUsers(list);
      if(getCurrentId()===id) setCurrentId(null);
      refreshLoginSelect(); refreshCurrentView();
      alert('削除しました');
    }
  });

  // ログアウト
  logoutBtn.addEventListener('click', ()=>{
    setCurrentId(null);
    refreshCurrentView();
    alert('ログアウトしました');
  });

  /* ===== ゲーム進行 ===== */
  async function runSequence(){
    clearAll();
    line.classList.remove("show");
    summary.classList.remove("show");
    summary.textContent="";
    boxes.forEach(b=>b.classList.remove("stopped"));

    // 音源準備待ち
    await new Promise((resolve)=>{
      const ok=()=>{ bgm.removeEventListener("canplaythrough", ok); resolve(); };
      bgm.addEventListener("canplaythrough", ok, {once:true});
      if (bgm.readyState>=3 || bgm.duration>0) resolve();
      setTimeout(resolve, 600);
    });

    try{
      bgm.pause();
      bgm.currentTime = 0;
      await bgm.play(); // クリック起点
    }catch(e){
      alert("再生がブロックされました。もう一度ボタンを押してください。");
      return;
    }

    startSpin();
    const start = performance.now();

    schedule(()=>{ line.classList.add("show"); }, cues.line, start);

    const picked = {height:"",face:"",mbti:"",age:"",country:""};
    schedule(()=>{ picked.height  = stopBox(0); }, cues.height,  start);
    schedule(()=>{ picked.face    = stopBox(1); }, cues.face,    start);
    schedule(()=>{ picked.mbti    = stopBox(2); }, cues.mbti,    start);
    schedule(()=>{ picked.age     = stopBox(3); }, cues.age,     start);
    schedule(()=>{ picked.country = stopBox(4); }, cues.country, start);

    schedule(()=>{
      const label = `${picked.country} / ${picked.height} / ${picked.face} / ${picked.mbti} / ${picked.age}`;

      // ログイン中ユーザーを結果に添える
      const me = getCurrentUser();
      const meLine = me
        ? `\n\nあなた（${me.displayName} / ${me.age?me.age+'歳':'年齢:不明'} / ${me.face||'顔の系統:不明'} / ${me.mbti||'MBTI:不明'} / ${me.country||'国籍:不明'}）`
        : '';

      summary.textContent = `おめでとうございます！\n${label}\nが運命の相手です。${meLine}`;
      summary.classList.add("show");
    }, cues.summary, start);
  }

  let busy=false;
  btn.addEventListener("click", async ()=>{
    if (busy) return; busy=true;
    try { await runSequence(); } finally { setTimeout(()=>busy=false, 22000); }
  });
})();
</script>
</body>
</html>
