<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Unmei - å‡ºä¼šã„ãŒé³´ã‚Šã€æ‹ãŒå¥ã§ã‚‹é‹å‘½</title>

<!-- Playfair Displayï¼ˆçµ±ä¸€ãƒ•ã‚©ãƒ³ãƒˆï¼‰ -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root { --gold:#ffd700; }

  /* === å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šå·¦ã«ã‚²ãƒ¼ãƒ ã€å³ã«èªè¨¼ãƒ‘ãƒãƒ« === */
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    background:#000;
    height:100svh;
    overflow:hidden;
    font-family:'Playfair Display', serif;
    color:var(--gold);
  }
  .app{
    display:flex;
    height:100svh;
    width:100vw;
  }

  /* å·¦ï¼šã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆç¸®å°ºãƒ•ã‚£ãƒƒãƒˆï¼‰ */
  .stage-wrap{
    position:relative;
    flex:1 1 auto;
    width:100%;
    height:100%;
    overflow:hidden;
  }
  .stage{
    position:absolute;
    left:50%;
    top:50%;
    width:1280px;              /* åŸºæº–å¹… */
    height:720px;              /* åŸºæº–é«˜ */
    transform-origin:center center; /* scaleã¯JSã§è¨­å®šã—ã¾ã™ */
    background:radial-gradient(circle at center,#1c0d0d 0%,#000 80%);
    border-radius:10px;
    box-shadow:0 0 40px rgba(255,215,0,0.08) inset;
  }

  /* ===== ã‚¹ãƒ†ãƒ¼ã‚¸å†…UI ===== */
  h1{
    position:absolute; left:50%; top:40px; transform:translateX(-50%);
    margin:0; font-size:72px; letter-spacing:3px;
    text-shadow:0 0 25px rgba(255,215,0,1);
  }
  .subtitle{
    position:absolute; left:50%; top:120px; transform:translateX(-50%);
    margin:0; font-size:22px; letter-spacing:2px;
    text-shadow:0 0 15px rgba(255,215,0,0.8); text-align:center;
  }

  .slot{
    position:absolute; left:50%; top:160px; transform:translateX(-50%);
    display:flex; gap:16px;
  }
  .slot-box{
    width:120px; height:100px;
    background:linear-gradient(180deg,#2a1b1b,#3a0303);
    border:2px solid var(--gold); border-radius:12px;
    display:flex; align-items:center; justify-content:center;
    text-align:center; font-weight:700; font-size:20px;
    box-shadow:0 0 15px rgba(255,215,0,0.45);
    user-select:none; transition:filter .2s, box-shadow .2s;
  }
  .spinning{ filter:saturate(1.2) brightness(1.1); box-shadow:0 0 18px rgba(255,215,0,0.6); }
  .stopped { filter:none; }

  .cta{
    position:absolute; left:50%; top:340px; transform:translateX(-50%);
    background:linear-gradient(90deg,#8b0000,#b30000);
    color:var(--gold); border:2px solid var(--gold); border-radius:12px;
    padding:14px 36px; font-size:24px; cursor:pointer;
    text-shadow:0 0 12px rgba(255,215,0,0.8);
    box-shadow:0 0 25px rgba(255,215,0,0.35);
    transition:transform .25s, box-shadow .25s, filter .25s; z-index:5;
  }
  .cta:hover{ transform:translateX(-50%) translateY(-1px) scale(1.04); box-shadow:0 0 35px rgba(255,215,0,0.8); filter:brightness(1.05); }
  .cta:active{ transform:translateX(-50%) translateY(0) scale(0.98); box-shadow:0 0 22px rgba(255,215,0,0.6); }

  .keys{
    position:absolute; left:50%; bottom:0; transform:translateX(-50%);
    display:flex; gap:2px; padding:8px 0 10px; pointer-events:none;
  }
  .key{ width:64px; height:280px; background:linear-gradient(to bottom,#fff,#ddd);
        border:1px solid #444; border-radius:4px; position:relative;
        box-shadow:0 4px 10px rgba(255,255,255,0.08);}
  .key.black{ width:42px; height:180px; background:linear-gradient(to bottom,#111,#000);
              margin:0 -21px; z-index:2; border-color:#222; box-shadow:0 4px 10px rgba(0,0,0,0.35);}
  .flash{ box-shadow:0 0 22px rgba(255,215,0,0.9)!important; filter:brightness(2) saturate(1.2); }

  .footer-note{ position:absolute; left:50%; bottom:8px; transform:translateX(-50%); font-size:14px; opacity:.85; }

  .result-line, .result-summary{
    position:absolute; left:50%; transform:translateX(-50%);
    text-shadow:0 0 18px rgba(255,215,0,0.9); opacity:0; transition:opacity .9s ease;
    text-align:center; white-space:pre-wrap; letter-spacing:2px;
  }
  .result-line{ top:460px; font-size:28px; }
  .result-summary{ top:520px; font-size:22px; }
  .show{ opacity:1; }

  .page-bg { position:fixed; inset:0; background:#000; z-index:-1; }

  /* å³ï¼šãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ²ãƒ‘ãƒãƒ« */
  .side{
    width:min(420px, 42vw);
    border-left:1px solid rgba(255,215,0,.15);
    background:linear-gradient(180deg,#0a0606,#000);
    padding:18px 16px 14px;
    display:flex; flex-direction:column; gap:12px;
  }
  .side h2{ margin:0 0 6px; font-size:22px; letter-spacing:1px; text-shadow:0 0 12px rgba(255,215,0,.6); }
  .tabs{ display:flex; gap:8px; }
  .tab{
    flex:1; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,215,0,.35);
    background:#1a1212; color:var(--gold); cursor:pointer; font-size:14px;
  }
  .tab.active{ background:#3a1a1a; border-color:var(--gold); }
  .pane.hidden{ display:none; }

  .field{ display:flex; flex-direction:column; gap:6px; margin-top:8px; }
  .field label{ font-size:13px; opacity:.95; }
  .field input, .field select{
    width:100%; padding:10px; border-radius:10px; border:1px solid #443;
    background:#0e0a0a; color:#fff; font-size:15px;
  }

  .side-btn{
    padding:10px 12px; border-radius:10px; border:1px solid var(--gold);
    background:#240909; color:var(--gold); cursor:pointer; font-size:15px;
  }
  .side-btn.ghost{ border-color:#666; color:#ddd; background:#111; }
  .side-btn.warning{ border-color:#b66; color:#fdd; background:#2a0a0a; }
  .note{ font-size:12px; opacity:.8; margin:4px 0 0; }
  .current{
    margin-top:6px; padding:10px; border:1px dashed rgba(255,215,0,.35); border-radius:10px; font-size:14px;
  }

  /* ãƒ¢ãƒã‚¤ãƒ«æ™‚ã¯ã‚µã‚¤ãƒ‰ã‚’ä¸‹é…ç½® */
  @media (max-width: 980px){
    .app{ flex-direction:column; }
    .side{ width:100%; height:auto; order:-1; border-left:none; border-bottom:1px solid rgba(255,215,0,.15); }
  }
</style>
</head>
<body>
  <div class="page-bg"></div>

  <div class="app">
    <!-- å·¦ï¼šã‚²ãƒ¼ãƒ  -->
    <div class="stage-wrap">
      <div class="stage" id="stage">
        <h1>Unmei</h1>
        <p class="subtitle">å‡ºä¼šã„ãŒé³´ã‚Šã€æ‹ãŒå¥ã§ã‚‹é‹å‘½</p>

        <div class="slot" aria-live="polite">
          <div class="slot-box" data-field="height">èº«é•·</div>
          <div class="slot-box" data-field="face">é¡”</div>
          <div class="slot-box" data-field="mbti">MBTI</div>
          <div class="slot-box" data-field="age">å¹´é½¢</div>
          <div class="slot-box" data-field="country">å›½ç±</div>
        </div>

        <button class="cta" aria-label="é‹å‘½ã‚’å¥ã§ã‚‹ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆï¼‰">é‹å‘½ã‚’å¥ã§ã‚‹</button>

        <!--  åŒéšå±¤ã«ç½®ã„ãŸMP3ï¼ˆæ—¢å®šï¼‰ã€‚playsinlineã§iOSå¯¾ç­– -->
        <audio id="bgm" preload="auto" playsinline>
          <source src="beethoven_symphony5_1.mp3" type="audio/mpeg" />
        </audio>

        <!-- éµç›¤ -->
        <div class="keys" aria-hidden="true">
          <div class="key"></div><div class="key black"></div><div class="key"></div><div class="key black"></div>
          <div class="key"></div><div class="key"></div><div class="key black"></div><div class="key"></div>
          <div class="key black"></div><div class="key"></div><div class="key black"></div><div class="key"></div>
          <div class="key"></div><div class="key black"></div><div class="key"></div><div class="key black"></div>
          <div class="key"></div><div class="key"></div><div class="key black"></div><div class="key"></div>
          <div class="key black"></div><div class="key"></div><div class="key black"></div><div class="key"></div>
          <div class="key"></div><div class="key black"></div><div class="key"></div><div class="key black"></div><div class="key"></div>
        </div>

        <div class="footer-note">Â© 2025 Unmei Project</div>

        <!-- çµæœãƒ†ã‚­ã‚¹ãƒˆ -->
        <div class="result-line" id="resultLine">ã‚ãªãŸã®é‹å‘½ã®ç›¸æ‰‹ã¯...</div>
        <div class="result-summary" id="resultSummary"></div>
      </div>
    </div>

    <!-- å³ï¼šãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ² -->
    <aside class="side">
      <h2>Unmei ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h2>
      <div class="tabs">
        <button class="tab active" data-tab="login">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button class="tab" data-tab="register">æ–°è¦ç™»éŒ²</button>
      </div>

      <!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
      <div id="pane-login" class="pane">
        <div class="field">
          <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠ</label>
          <select id="loginUser"></select>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px;">
          <button id="doLogin" class="side-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
          <button id="deleteUser" class="side-btn ghost">é¸æŠãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤</button>
        </div>
        <div class="current" id="currentUserView">æœªãƒ­ã‚°ã‚¤ãƒ³</div>

        <hr style="width:100%; border:0; border-top:1px solid rgba(255,215,0,.15); margin:12px 0 6px;">
        <h2 style="font-size:18px; margin:0 0 6px;">BGM</h2>
        <div class="field">
          <label>MP3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆç«¯æœ«å†…ï¼‰ï¼š</label>
          <input id="bgmFile" type="file" accept="audio/*" />
        </div>
        <div class="field">
          <label>MP3ã®URLã‚’å…¥åŠ›ï¼ˆhttps://ã€œï¼‰ï¼š</label>
          <div style="display:flex; gap:8px;">
            <input id="bgmUrl" type="url" placeholder="https://example.com/fate.mp3" />
            <button id="loadUrl" class="side-btn">èª­è¾¼</button>
          </div>
          <p class="note">â€» GitHub Pages ç­‰ã¯CORSã§å†ç”Ÿä¸å¯ã®ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãã®å ´åˆã¯ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚</p>
        </div>
      </div>

      <!-- æ–°è¦ç™»éŒ² -->
      <div id="pane-register" class="pane hidden">
        <div class="field">
          <label>è¡¨ç¤ºåï¼ˆå½åOKï¼‰</label>
          <input id="regName" type="text" placeholder="ä¾‹ï¼šã‚ã‚†ğŸ€ / Kuma" />
        </div>
        <div class="field">
          <label>å¹´é½¢</label>
          <input id="regAge" type="number" min="10" max="120" placeholder="ä¾‹ï¼š21" />
        </div>
        <div class="field">
          <label>é¡”ã®ç³»çµ±</label>
          <select id="regFace"></select>
        </div>
        <div class="field">
          <label>MBTI</label>
          <select id="regMBTI"></select>
        </div>
        <div class="field">
          <label>å›½ç±</label>
          <select id="regCountry"></select>
        </div>
        <button id="doRegister" class="side-btn" style="margin-top:10px;">ç™»éŒ²ã™ã‚‹</button>
        <p class="note">â€»è¡¨ç¤ºåã¯å½åã§OKã€‚ä¿å­˜ã¯ã“ã®ç«¯æœ«ï¼ˆlocalStorageï¼‰ã®ã¿ã€‚</p>
      </div>

      <hr style="width:100%; border:0; border-top:1px solid rgba(255,215,0,.15); margin:8px 0;">
      <button id="logout" class="side-btn warning">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </aside>
  </div>

<script>
(function(){
  /* ===== ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’å¸¸ã«ç”»é¢å†…ã«åã‚ã‚‹ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚° ===== */
  const stage = document.getElementById('stage');
  const BASE_W = 1280, BASE_H = 720;

  function fitStage(){
    const wrap = stage.parentElement;
    const sw = wrap.clientWidth;
    const sh = wrap.clientHeight;
    const scale = Math.min(sw / BASE_W, sh / BASE_H);
    stage.style.transform = `translate(-50%, -50%) scale(${scale})`;
  }
  window.addEventListener('resize', fitStage);
  window.addEventListener('orientationchange', fitStage);
  new ResizeObserver(fitStage).observe(stage.parentElement);
  fitStage();

  /* ===== ãƒ‡ãƒ¼ã‚¿ ===== */
  const faces = ["ã—ãŠé¡”","ã‚½ãƒ¼ã‚¹é¡”","ã¨ã‚“ã“ã¤é¡”","ç ‚ç³–é¡”","ã—ã‚‡ã†ã‚†é¡”","å¡©ãƒã‚¿ãƒ¼é¡”"];
  const mbti  = ["INTJ","INFP","ENTP","ENFJ","ISTP","ISFP","ESTJ","ESFP","ISTJ","INFJ","ENTJ","ENFP","ISFJ","ESFJ","ESTP","INTP"];
  const countries = ["æ—¥æœ¬","éŸ“å›½","ãƒ•ãƒ©ãƒ³ã‚¹","ã‚¤ã‚®ãƒªã‚¹","ãƒ‰ã‚¤ãƒ„","ã‚¤ã‚¿ãƒªã‚¢","ã‚¢ãƒ¡ãƒªã‚«","ãƒ–ãƒ©ã‚¸ãƒ«","ã‚¨ã‚¸ãƒ—ãƒˆ","ã‚¿ã‚¤","ã‚¹ãƒšã‚¤ãƒ³","ã‚«ãƒŠãƒ€","ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢"];

  /* ===== ã‚²ãƒ¼ãƒ è¦ç´  ===== */
  const boxes = Array.from(document.querySelectorAll(".slot-box"));
  const keys  = Array.from(document.querySelectorAll(".keys .key"));
  const btn   = document.querySelector(".cta");
  const bgm   = document.getElementById("bgm");
  const line = document.getElementById("resultLine");
  const summary = document.getElementById("resultSummary");

  // BGM å–ã‚Šè¾¼ã¿UI
  const bgmFile = document.getElementById('bgmFile');
  const bgmUrl  = document.getElementById('bgmUrl');
  const loadUrlBtn = document.getElementById('loadUrl');
  const BGM_URL_KEY = 'unmeiBgmUrl';
  const lastUrl = localStorage.getItem(BGM_URL_KEY) || '';
  if (lastUrl) bgmUrl.value = lastUrl;

  function setBgmSrc(src, {persist=false} = {}){
    if (!src) return;
    try{ bgm.pause(); }catch(_){}
    bgm.removeAttribute('src');
    bgm.src = src;
    bgm.load();
    if (persist) localStorage.setItem(BGM_URL_KEY, src);
  }
  bgmFile.addEventListener('change', ()=>{
    const f = bgmFile.files && bgmFile.files[0];
    if (!f) return;
    const url = URL.createObjectURL(f);
    setBgmSrc(url, {persist:false});
  });
  loadUrlBtn.addEventListener('click', ()=>{
    const url = (bgmUrl.value || '').trim();
    if (!url) return;
    try{ new URL(url); }catch(_){ alert('æ­£ã—ã„URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    setBgmSrc(url, {persist:true});
    alert('BGMã®URLã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
  });

  const cues = {
    line:     1500,   // ã‚ãªãŸã®é‹å‘½ã®ç›¸æ‰‹ã¯...
    height:   4200,   // èº«é•·
    face:     7500,   // é¡”
    mbti:     9800,   // MBTI
    age:     12100,   // å¹´é½¢
    country:  14500,  // å›½ç±
    summary:  17500   // ã¾ã¨ã‚
  };

  const timeouts = [];
  const spinners = [];
  function schedule(fn, delayMs, startMs){
    const h = setTimeout(fn, Math.max(0, startMs + delayMs - performance.now()));
    timeouts.push(h);
  }
  function clearAll(){
    while(timeouts.length){ clearTimeout(timeouts.pop()); }
    spinners.splice(0).forEach(id => clearInterval(id));
  }
  function flashKey(){
    const k = keys[Math.floor(Math.random()*keys.length)];
    if(!k) return; k.classList.add("flash"); setTimeout(()=>k.classList.remove("flash"), 120);
  }
  function startSpin(){
    boxes.forEach((box)=>{
      box.classList.add("spinning");
      const id=setInterval(()=>{
        switch(box.dataset.field){
          case "height":  box.textContent=(150+Math.floor(Math.random()*51))+"cm"; break;
          case "face":    box.textContent=faces[Math.floor(Math.random()*faces.length)]; break;
          case "mbti":    box.textContent=mbti[Math.floor(Math.random()*mbti.length)]; break;
          case "age":     box.textContent=(18+Math.floor(Math.random()*23))+"æ­³"; break;
          case "country": box.textContent=countries[Math.floor(Math.random()*countries.length)]; break;
        }
      }, 45);
      spinners.push(id);
    });
  }
  function stopBox(i){
    if (spinners[i]) { clearInterval(spinners[i]); spinners[i]=null; }
    boxes[i].classList.remove("spinning");
    boxes[i].classList.add("stopped");
    flashKey();
    return boxes[i].textContent;
  }

  /* ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼ˆlocalStorageï¼‰ ===== */
  const USERS_KEY = "unmeiUsers";
  const CURRENT_ID_KEY = "unmeiCurrentUserId";

  const $ = (sel)=>document.querySelector(sel);

  // ãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ² UI
  const tabs = Array.from(document.querySelectorAll(".tab"));
  const paneLogin = $("#pane-login");
  const paneRegister = $("#pane-register");
  const loginSelect = $("#loginUser");
  const doLoginBtn = $("#doLogin");
  const delUserBtn = $("#deleteUser");
  const logoutBtn = $("#logout");
  const curView = $("#currentUserView");

  const regName = $("#regName");
  const regAge = $("#regAge");
  const regFace = $("#regFace");
  const regMBTI = $("#regMBTI");
  const regCountry = $("#regCountry");
  const doRegisterBtn = $("#doRegister");

  // ã‚»ãƒ¬ã‚¯ãƒˆã«é¸æŠè‚¢æŠ•å…¥
  function fillOptions(select, arr){
    select.innerHTML = '<option value="">ï¼ˆæœªè¨­å®šï¼‰</option>' + arr.map(v=>`<option value="${v}">${v}</option>`).join('');
  }
  fillOptions(regFace, faces);
  fillOptions(regMBTI, mbti);
  fillOptions(regCountry, countries);

  // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ I/O
  function loadUsers(){
    try{ return JSON.parse(localStorage.getItem(USERS_KEY) || "[]"); }catch(_){ return []; }
  }
  function saveUsers(arr){
    localStorage.setItem(USERS_KEY, JSON.stringify(arr));
  }
  function setCurrentId(id){
    if(id==null){ localStorage.removeItem(CURRENT_ID_KEY); }
    else{ localStorage.setItem(CURRENT_ID_KEY, String(id)); }
  }
  function getCurrentId(){
    return localStorage.getItem(CURRENT_ID_KEY);
  }
  function getCurrentUser(){
    const id = getCurrentId();
    if(!id) return null;
    return loadUsers().find(u=>String(u.id)===String(id)) || null;
  }
  function refreshLoginSelect(){
    const users = loadUsers();
    loginSelect.innerHTML = users.length
      ? users.map(u=>`<option value="${u.id}">${u.displayName} (${u.country||'å›½ç±ä¸æ˜'})</option>`).join('')
      : '<option value="">ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æœªç™»éŒ²ï¼‰</option>';
  }
  function refreshCurrentView(){
    const me = getCurrentUser();
    if(me){
      curView.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${me.displayName} / ${me.age?me.age+'æ­³':'å¹´é½¢:ä¸æ˜'} / ${me.face||'é¡”ã®ç³»çµ±:ä¸æ˜'} / ${me.mbti||'MBTI:ä¸æ˜'} / ${me.country||'å›½ç±:ä¸æ˜'}`;
    }else{
      curView.textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³';
    }
  }

  // åˆæœŸåŒ–
  refreshLoginSelect();
  refreshCurrentView();

  // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
  tabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      tabs.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      paneLogin.classList.toggle('hidden', tab!=='login');
      paneRegister.classList.toggle('hidden', tab!=='register');
      // ãƒ‘ãƒãƒ«é«˜ã•å¤‰åŒ–ã§ã‚‚ã‚¹ãƒ†ãƒ¼ã‚¸ç¸®å°ºã‚’æ›´æ–°
      requestAnimationFrame(fitStage);
    });
  });

  // æ–°è¦ç™»éŒ²
  doRegisterBtn.addEventListener('click', ()=>{
    const name = (regName.value || '').trim();
    if(!name){ alert('è¡¨ç¤ºåï¼ˆå½åOKï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    const age = regAge.value ? Math.max(0, Math.min(150, Number(regAge.value)|0)) : "";
    const user = {
      id: Date.now().toString(36) + Math.random().toString(36).slice(2,7),
      displayName: name,
      age: age ? String(age) : "",
      face: regFace.value || "",
      mbti: regMBTI.value || "",
      country: regCountry.value || ""
    };
    const list = loadUsers(); list.push(user); saveUsers(list);
    setCurrentId(user.id);
    refreshLoginSelect(); refreshCurrentView();
    regName.value = ""; regAge.value=""; regFace.value=""; regMBTI.value=""; regCountry.value="";
    alert('ç™»éŒ²ã—ã¾ã—ãŸï¼ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«ãªã‚Šã¾ã—ãŸã€‚');
    document.querySelector('.tab[data-tab="login"]').click();
  });

  // ãƒ­ã‚°ã‚¤ãƒ³
  doLoginBtn.addEventListener('click', ()=>{
    const id = loginSelect.value;
    if(!id){ alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    setCurrentId(id);
    refreshCurrentView();
    alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ');
  });

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
  delUserBtn.addEventListener('click', ()=>{
    const id = loginSelect.value;
    if(!id){ alert('å‰Šé™¤ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    const list = loadUsers();
    const idx = list.findIndex(u=>String(u.id)===String(id));
    if(idx>=0){
      if(!confirm(`æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n${list[idx].displayName}`)) return;
      list.splice(idx,1); saveUsers(list);
      if(getCurrentId()===id) setCurrentId(null);
      refreshLoginSelect(); refreshCurrentView();
      alert('å‰Šé™¤ã—ã¾ã—ãŸ');
    }
  });

  // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
  logoutBtn.addEventListener('click', ()=>{
    setCurrentId(null);
    refreshCurrentView();
    alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
  });

  /* ===== ãƒãƒƒãƒè¨ˆç®—ï¼ˆä¸Šä½3äººï¼‰ ===== */
  function calcMatchScore(me, u){
    // 100ç‚¹æº€ç‚¹ï¼šé¡”30 / MBTI40 / å›½ç±20 / å¹´é½¢å·®Â±3æ­³ 10
    let score = 0;
    if(me && u){
      if(me.face && u.face && me.face === u.face) score += 30;
      if(me.mbti && u.mbti && me.mbti === u.mbti) score += 40;
      if(me.country && u.country && me.country === u.country) score += 20;
      const a = Number(me.age), b = Number(u.age);
      if(a && b && Math.abs(a - b) <= 3) score += 10;
    }
    return score;
  }
  function rankTopMatches(me, k=3){
    const candidates = loadUsers().filter(u => !me || u.id !== me.id);
    const scored = candidates.map(u => ({ u, score: calcMatchScore(me,u) }));
    scored.sort((a,b)=> b.score - a.score);
    return scored.slice(0, k);
  }

  /* ===== ã‚²ãƒ¼ãƒ é€²è¡Œ ===== */
  async function runSequence(){
    clearAll();
    line.classList.remove("show");
    summary.classList.remove("show");
    summary.textContent="";
    boxes.forEach(b=>b.classList.remove("stopped"));

    // éŸ³æºæº–å‚™å¾…ã¡
    await new Promise((resolve)=>{
      const ok=()=>{ bgm.removeEventListener("canplaythrough", ok); resolve(); };
      bgm.addEventListener("canplaythrough", ok, {once:true});
      if (bgm.readyState>=3 || bgm.duration>0) resolve();
      setTimeout(resolve, 600);
    });

    try{
      bgm.pause();
      bgm.currentTime = 0;
      await bgm.play(); // ã‚¯ãƒªãƒƒã‚¯èµ·ç‚¹
    }catch(e){
      alert("å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    startSpin();
    const start = performance.now();

    schedule(()=>{ line.classList.add("show"); }, cues.line, start);

    const picked = {height:"",face:"",mbti:"",age:"",country:""};
    schedule(()=>{ picked.height  = stopBox(0); }, cues.height,  start);
    schedule(()=>{ picked.face    = stopBox(1); }, cues.face,    start);
    schedule(()=>{ picked.mbti    = stopBox(2); }, cues.mbti,    start);
    schedule(()=>{ picked.age     = stopBox(3); }, cues.age,     start);
    schedule(()=>{ picked.country = stopBox(4); }, cues.country, start);

    schedule(()=>{
      const label = `${picked.country} / ${picked.height} / ${picked.face} / ${picked.mbti} / ${picked.age}`;

      // è‡ªåˆ†æƒ…å ±
      const me = getCurrentUser();
      const meLine = me
        ? `\n\nã‚ãªãŸï¼ˆ${me.displayName} / ${me.age?me.age+'æ­³':'å¹´é½¢:ä¸æ˜'} / ${me.face||'é¡”:ä¸æ˜'} / ${me.mbti||'MBTI:ä¸æ˜'} / ${me.country||'å›½ç±:ä¸æ˜'}ï¼‰`
        : '';

      // ä¸Šä½3äºº
      let top3Block = '';
      if(me){
        const top3 = rankTopMatches(me, 3).filter(item => item.u); // å¿µã®ãŸã‚
        if(top3.length){
          const lines = top3.map((item, idx)=>{
            const u = item.u;
            return ` ${idx+1}. ${u.displayName}ï¼ˆ${u.mbti||'MBTIä¸æ˜'} / ${u.face||'é¡”:ä¸æ˜'} / ${u.country||'å›½ç±:ä¸æ˜'}ï¼‰ - ãƒãƒƒãƒåº¦ï¼š${item.score}%`;
          }).join('\n');
          top3Block =
            `\n\nğŸ¼ é‹å‘½ã®æ—‹å¾‹ã‚’å¥ã§ãŸç›¸æ‰‹ï¼ˆä¸Šä½3äººï¼‰\n` +
            lines;
        }else{
          top3Block = `\n\nğŸ’ ä»–ã®ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“ã€‚`;
        }
      }else{
        top3Block = `\n\nğŸ’ ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦è‡ªåˆ†ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€ã‚ãªãŸã«åˆã†ç›¸æ‰‹ã‚’ã”ç´¹ä»‹ã§ãã¾ã™ã€‚`;
      }

      // ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
      const ending = `\n\nã“ã‚Œã¯å¶ç„¶ã®æ—‹å¾‹ã‹ã€\nãã‚Œã¨ã‚‚â”€â”€é‹å‘½ã®ãƒ‡ãƒ¥ã‚¨ãƒƒãƒˆã‹ã€‚`;

      summary.textContent =
        `ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼\n${label}\nãŒé‹å‘½ã®ç›¸æ‰‹ã§ã™ã€‚` +
        meLine + top3Block + ending;

      summary.classList.add("show");
    }, cues.summary, start);
  }

  let busy=false;
  btn.addEventListener("click", async ()=>{
    if (busy) return; busy=true;
    try { await runSequence(); } finally { setTimeout(()=>busy=false, 22000); }
  });
})();
</script>
</body>
</html>
