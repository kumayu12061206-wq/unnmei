<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Unmei - 出会いが鳴り、恋が奏でる運命</title>

  <!-- Playfair Display（統一フォント） -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root { --gold:#ffd700; }
    * { box-sizing: border-box; }
    body {
      margin: 0; height: 100vh; overflow: hidden;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      background: radial-gradient(circle at center, #1c0d0d 0%, #000 80%);
      font-family: 'Playfair Display', serif;
      color: var(--gold);
    }
    h1 {
      font-size: clamp(40px, 8vw, 72px);
      color: var(--gold); text-shadow: 0 0 25px rgba(255,215,0,1);
      letter-spacing: 3px; margin: 24px 16px 8px;
      animation: fadeIn 1.2s ease forwards;
    }
    p {
      font-size: clamp(14px, 2.5vw, 22px);
      color: var(--gold); letter-spacing: 2px; margin: 0 16px 8px;
      text-align: center; text-shadow: 0 0 15px rgba(255,215,0,0.8);
      opacity: 0; animation: subtitle 1s ease .5s forwards;
    }
    @keyframes fadeIn { from{opacity:0;transform:translateY(40px)} to{opacity:1;transform:translateY(0)} }
    @keyframes subtitle { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }

    .slot {
      position: absolute; top: 12%; left: 50%; transform: translateX(-50%);
      display: flex; gap: clamp(8px, 2vw, 16px); flex-wrap: wrap;
      max-width: min(100vw, 900px); padding: 0 8px; opacity: 0;
      animation: slotFade 1s ease .8s forwards;
    }
    @keyframes slotFade { to{opacity:1} }
    .slot-box {
      width: clamp(92px, 16vw, 140px); height: clamp(76px, 10vw, 110px);
      background: linear-gradient(180deg,#2a1b1b,#3a0303);
      border: 2px solid var(--gold); border-radius: 12px;
      color: var(--gold); font-weight: 700; font-size: clamp(14px, 2.2vw, 20px);
      display: flex; align-items: center; justify-content: center; text-align:center;
      box-shadow: 0 0 15px rgba(255,215,0,0.45);
      transition: filter .2s, box-shadow .2s;
      user-select: none;
    }
    .spinning { filter: saturate(1.2) brightness(1.1); box-shadow: 0 0 18px rgba(255,215,0,0.6); }
    .stopped { filter: none; }

    .keys {
      position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
      display: flex; gap: 2px; padding: 8px 0 10px; pointer-events: none;
      /* タイトル・ボタンが鍵盤と重ならないよう、見かけの余白はボタン側で確保 */
    }
    .key {
      width: 64px; height: 280px; background: linear-gradient(to bottom,#fff,#ddd);
      border: 1px solid #444; border-radius: 4px; position: relative;
      animation: play 6s infinite ease-in-out; box-shadow: 0 4px 10px rgba(255,255,255,0.08);
      transition: filter .12s linear, box-shadow .12s linear;
    }
    .key.black {
      width: 42px; height: 180px; background: linear-gradient(to bottom,#111,#000);
      margin: 0 -21px; z-index: 2; border-color:#222; box-shadow: 0 4px 10px rgba(0,0,0,0.35);
      animation: playBlack 6s infinite ease-in-out;
    }
    @keyframes play { 0%,100%{filter:brightness(1)} 50%{filter:brightness(1.6)} }
    @keyframes playBlack { 0%,100%{filter:brightness(1)} 50%{filter:brightness(1.3)} }
    .flash { box-shadow: 0 0 22px rgba(255,215,0,0.9)!important; filter: brightness(2) saturate(1.2); }

    button.cta {
      position: relative; z-index: 5;
      margin-top: clamp(16px, 6vh, 100px);
      background: linear-gradient(90deg,#8b0000,#b30000);
      color: var(--gold); border: 2px solid var(--gold); border-radius: 12px;
      padding: 14px 36px; font-size: clamp(16px, 3.4vw, 24px);
      cursor: pointer; text-shadow: 0 0 12px rgba(255,215,0,0.8);
      box-shadow: 0 0 25px rgba(255,215,0,0.35);
      transition: transform .25s, box-shadow .25s, filter .25s;
    }
    button.cta:hover { transform: translateY(-1px) scale(1.04); box-shadow: 0 0 35px rgba(255,215,0,0.8); filter: brightness(1.05); }
    button.cta:active { transform: translateY(0) scale(0.98); box-shadow: 0 0 22px rgba(255,215,0,0.6); }

    .footer-note {
      position: absolute; bottom: 8px; color: var(--gold); font-size: 12px;
      text-shadow: 0 0 10px rgba(255,215,0,0.6); opacity: .85;
    }

    /* 結果テキスト */
    .result-line, .result-summary {
      position: absolute; left: 50%; transform: translateX(-50%);
      color: var(--gold); text-shadow: 0 0 18px rgba(255,215,0,0.9); opacity: 0;
      transition: opacity 0.9s ease;
      text-align: center; white-space: pre-wrap; letter-spacing: 2px;
    }
    .result-line { top: 65%; font-size: 28px; }
    .result-summary { top: 74%; font-size: 22px; }
    .show { opacity: 1; }
  </style>
</head>
<body>
  <h1>Unmei</h1>
  <p>出会いが鳴り、恋が奏でる運命</p>

  <!-- スロット -->
  <div class="slot" aria-live="polite">
    <div class="slot-box" data-field="height">身長</div>
    <div class="slot-box" data-field="face">顔</div>
    <div class="slot-box" data-field="mbti">MBTI</div>
    <div class="slot-box" data-field="age">年齢</div>
    <div class="slot-box" data-field="country">国籍</div>
  </div>

  <!-- CTA -->
  <button class="cta" aria-label="運命を奏でる（スタート）">運命を奏でる</button>

  <!-- BGM：Wikimedia Commons の PD 録音（OGG）。Safari等OGG不可はWebAudioに自動フォールバック -->
  <audio id="bgm" preload="auto" crossorigin="anonymous">
    <source src="https://commons.wikimedia.org/wiki/Special:FilePath/Ludwig%20van%20Beethoven%20-%20Symphonie%205%20c-moll%20-%201.%20Allegro%20con%20brio.ogg" type="audio/ogg">
  </audio>

  <!-- 鍵盤（見た目用） -->
  <div class="keys" aria-hidden="true">
    <div class="key"></div><div class="key black"></div><div class="key"></div><div class="key black"></div>
    <div class="key"></div><div class="key"></div><div class="key black"></div><div class="key"></div><div class="key black"></div>
    <div class="key"></div><div class="key black"></div><div class="key"></div><div class="key"></div><div class="key black"></div>
    <div class="key"></div><div class="key black"></div><div class="key"></div><div class="key"></div><div class="key black"></div>
    <div class="key"></div><div class="key black"></div><div class="key"></div><div class="key black"></div>
    <div class="key"></div><div class="key"></div><div class="key black"></div><div class="key"></div><div class="key black"></div><div class="key"></div>
  </div>

  <div class="footer-note">© 2025 Unmei Project</div>

  <script>
  (function(){
    // ===== ランダム表示データ =====
    const faces = ["しお顔","ソース顔","とんこつ顔","砂糖顔","しょうゆ顔","塩バター顔"];
    const mbti  = ["INTJ","INFP","ENTP","ENFJ","ISTP","ISFP","ESTJ","ESFP","ISTJ","INFJ","ENTJ","ENFP","ISFJ","ESFJ","ESTP","INTP"];
    const countries = ["日本","韓国","フランス","イギリス","ドイツ","イタリア","アメリカ","ブラジル","エジプト","タイ","スペイン","カナダ","オーストラリア"];

    const boxes = Array.from(document.querySelectorAll(".slot-box"));
    const keys  = Array.from(document.querySelectorAll(".keys .key"));
    const btn   = document.querySelector(".cta");
    const bgm   = document.getElementById("bgm");

    // 結果テキスト要素
    const line = document.createElement("div");
    line.className = "result-line";
    line.textContent = "あなたの運命の相手は...";
    document.body.appendChild(line);

    const summary = document.createElement("div");
    summary.className = "result-summary";
    document.body.appendChild(summary);

    // ===== クリックで鍵盤に合わせて演出 =====
    function flashKey(){
      const k = keys[Math.floor(Math.random()*keys.length)];
      if (!k) return;
      k.classList.add("flash");
      setTimeout(()=>k.classList.remove("flash"), 120);
    }

    // スロット回転
    const spinners = [];
    function startSpin(){
      boxes.forEach((box)=>{
        box.classList.add("spinning");
        const id = setInterval(()=>{
          switch(box.dataset.field){
            case "height":  box.textContent = (150 + Math.floor(Math.random()*51)) + "cm"; break;
            case "face":    box.textContent = faces[Math.floor(Math.random()*faces.length)]; break;
            case "mbti":    box.textContent = mbti[Math.floor(Math.random()*mbti.length)]; break;
            case "age":     box.textContent = (18 + Math.floor(Math.random()*23)) + "歳"; break;
            case "country": box.textContent = countries[Math.floor(Math.random()*countries.length)]; break;
          }
        }, 45);
        spinners.push(id);
      });
    }
    function stopBox(i){
      if (spinners[i]) { clearInterval(spinners[i]); spinners[i] = null; }
      boxes[i].classList.remove("spinning");
      boxes[i].classList.add("stopped");
      flashKey();
      return boxes[i].textContent;
    }

    // ====== OGGに同期するキュー（秒）※耳で微調整OK ======
    const CUE_SEC = {
      line:    1.5,   // 「あなたの運命の相手は...」
      height:  4.2,   // 身長 STOP
      face:    7.5,   // 顔 STOP
      mbti:    9.8,   // MBTI STOP
      age:    12.1,   // 年齢 STOP
      country:14.5,   // 国籍 STOP
      summary:17.5    // まとめ表示
    };

    // 一度だけ実行するヘルパ
    function once(fn){ let done=false; return ()=>{ if(!done){ done=true; fn(); } }; }

    // ===== WebAudio フォールバック（冒頭モチーフだけで順停止）=====
    let ac, master;
    function playFallbackMotif(){
      ac = ac || new (window.AudioContext || window.webkitAudioContext)();
      master = master || ac.createGain(); master.gain.value = 0.18; master.connect(ac.destination);

      const motif = [
        {f:392,d:0.28},{r:0.08},
        {f:392,d:0.28},{r:0.08},
        {f:392,d:0.28},{r:0.14},
        {f:311,d:0.44},{r:0.32}
      ];
      function tone(freq, t, d, type="square"){
        const o=ac.createOscillator(), g=ac.createGain();
        o.type=type; o.frequency.value=freq;
        g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(1,t+0.02); g.gain.linearRampToValueAtTime(0.0001,t+d);
        o.connect(g); g.connect(master); o.start(t); o.stop(t+d+0.02);
      }

      // リセット & 回転開始
      summary.textContent=""; line.classList.remove("show"); summary.classList.remove("show");
      boxes.forEach(b=>b.classList.remove("stopped"));
      startSpin();

      const t0 = ac.currentTime + 0.05; let cur=t0; let idx=0;
      motif.forEach(s=>{
        if (s.f){
          tone(s.f,cur,s.d, s.f===311?"sawtooth":"square");
          setTimeout(()=>{ if(idx<boxes.length){ stopBox(idx++); } }, (cur - ac.currentTime + s.d)*1000);
          cur += s.d;
        } else { cur += s.r; }
      });

      setTimeout(()=>{
        while(idx<boxes.length){ stopBox(idx++); }
        line.classList.add("show");
        setTimeout(()=>{
          const label = `${boxes[4].textContent} / ${boxes[0].textContent} / ${boxes[1].textContent} / ${boxes[2].textContent} / ${boxes[3].textContent}`;
          summary.textContent = `おめでとうございます！\n${label}\nが運命の相手です。`;
          summary.classList.add("show");
        }, 300);
      }, (cur - ac.currentTime + 0.3)*1000);
    }

    // ===== メイン：OGG再生に同期、NGならフォールバック =====
    function runSequenceByAudio(){
      // リセット
      summary.textContent = "";
      line.classList.remove("show");
      summary.classList.remove("show");
      boxes.forEach(b=>b.classList.remove("stopped"));

      startSpin();

      const canOgg = !!bgm.canPlayType && bgm.canPlayType('audio/ogg; codecs="vorbis"') !== "";
      if (!canOgg) { playFallbackMotif(); return; }

      bgm.currentTime = 0;
      bgm.play().then(()=>{
        const fire = {
          line:    once(()=> line.classList.add("show")),
          height:  once(()=> stopBox(0)),
          face:    once(()=> stopBox(1)),
          mbti:    once(()=> stopBox(2)),
          age:     once(()=> stopBox(3)),
          country: once(()=> stopBox(4)),
          summary: once(()=>{
            const label = `${boxes[4].textContent} / ${boxes[0].textContent} / ${boxes[1].textContent} / ${boxes[2].textContent} / ${boxes[3].textContent}`;
            summary.textContent = `おめでとうございます！\n${label}\nが運命の相手です。`;
            summary.classList.add("show");
          })
        };
        function onTick(){
          const t = bgm.currentTime;
          if (t>=CUE_SEC.line)    fire.line();
          if (t>=CUE_SEC.height)  fire.height();
          if (t>=CUE_SEC.face)    fire.face();
          if (t>=CUE_SEC.mbti)    fire.mbti();
          if (t>=CUE_SEC.age)     fire.age();
          if (t>=CUE_SEC.country) fire.country();
          if (t>=CUE_SEC.summary) fire.summary();
          if (bgm.ended) bgm.removeEventListener('timeupdate', onTick);
        }
        bgm.addEventListener('timeupdate', onTick);
      }).catch(()=>{
        // 自動再生ブロックや形式NG → フォールバック
        playFallbackMotif();
      });
    }

    // ボタン
    let busy = false;
    btn.addEventListener("click", ()=>{
      if (busy) return;
      busy = true;
      runSequenceByAudio();
      setTimeout(()=>{ busy = false; }, 22000); // 再プレイ解放（曲長に応じて調整）
    });

    // ページ離脱時の掃除
    window.addEventListener("pagehide", ()=>{ try{bgm.pause();}catch{} });
    window.addEventListener("beforeunload", ()=>{ try{bgm.pause();}catch{} });
  })();
  </script>
</body>
</html>
